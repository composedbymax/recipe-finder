<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recipe App</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; }
header { background:#4CAF50; color:#fff; text-align:center; padding:1rem; }
main { padding:1rem; }
section { margin-bottom:2rem; }
input, button { padding:0.5rem; margin-right:0.5rem; }
.recipe { border:1px solid #ddd; padding:1rem; margin:1rem 0; }
.recipe img { max-width:100%; }
.recipe-video { width:100%; height:315px; margin-top:1rem; border-radius:8px; }
ul { padding-left: 1.5rem; }
</style>
</head>
<body>
<header><h1>Recipe App</h1></header>
<main>
<section class="search">
<input id="ingredientInput" placeholder="Enter ingredient(s)">
<button id="searchBtn">Search</button>
<button id="randomBtn">Random Recipe</button>
</section>
<section class="recipes">
<h2>Results</h2>
<div id="results"></div>
</section>
<section class="saved">
<h2>Saved Recipes</h2>
<div id="savedRecipes"></div>
</section>
<template id="recipeTemplate">
<div class="recipe">
<h3 class="recipe-title"></h3>
<img class="recipe-img" src="" alt="Recipe Image">
<iframe class="recipe-video" frameborder="0" allowfullscreen></iframe>
<h4>Ingredients:</h4>
<ul class="recipe-ingredients"></ul>
<h4>Instructions:</h4>
<ol class="recipe-instructions"></ol>
<button class="saveBtn">Save</button>
<button class="editBtn">Edit</button>
</div>
</template>
    <script>
        let db;
        const request = indexedDB.open('RecipeDB', 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            const store = db.createObjectStore('recipes', { keyPath: 'idMeal' });
            store.createIndex('name', 'strMeal', { unique:false });
        };
        request.onsuccess = e => { db = e.target.result; displaySavedRecipes(); };
        request.onerror = e => console.error('IndexedDB error', e);
        function getEmbedUrl(youtubeUrl) {
            if (!youtubeUrl) return null;
            try {
                const url = new URL(youtubeUrl);
                const videoId = url.searchParams.get('v');
                return videoId ? `https://www.youtube.com/embed/${videoId}` : null;
            } catch {
                return null;
            }
        }
        async function fetchRecipes(query) {
            const endpoint = !query || query==='random'
                ? 'https://www.themealdb.com/api/json/v1/1/random.php'
                : `https://www.themealdb.com/api/json/v1/1/search.php?s=${encodeURIComponent(query)}`;
            const data = await (await fetch(endpoint)).json();
            displayRecipes(data.meals || []);
        }
        function parseInstructions(raw) {
            const steps = [];
            if (!raw) return steps;
            const lines = raw.split(/\r?\n|(?<=\.)\s*(?=\d+\.)/);
            lines.forEach(line => {
                let trimmed = line.trim();
                if (!trimmed) return;
                trimmed = trimmed.replace(/^(STEP\s*\d+|\d+\.)\s*/i, '').trim();
                if (trimmed) steps.push(trimmed);
            });
            return steps;
        }
        function displayRecipes(recipes) {
            const results = document.getElementById('results');
            results.innerHTML = '';
            const template = document.getElementById('recipeTemplate');
            recipes.forEach(recipe => {
                const clone = template.content.cloneNode(true);
                clone.querySelector('.recipe-title').textContent = recipe.strMeal;
                clone.querySelector('.recipe-img').src = recipe.strMealThumb;
                const ingredientsList = clone.querySelector('.recipe-ingredients');
                for(let i=1;i<=20;i++){
                    const ingredient = recipe['strIngredient'+i];
                    const measure = recipe['strMeasure'+i];
                    if(ingredient && ingredient.trim()!==''){
                        const li = document.createElement('li');
                        li.textContent = `${measure || ''} ${ingredient}`.trim();
                        ingredientsList.appendChild(li);
                    }
                }
                const instructionsList = clone.querySelector('.recipe-instructions');
                parseInstructions(recipe.strInstructions).forEach(step => {
                    const li = document.createElement('li');
                    li.textContent = step;
                    instructionsList.appendChild(li);
                });
                const videoFrame = clone.querySelector('.recipe-video');
                const embedUrl = getEmbedUrl(recipe.strYoutube);
                if (embedUrl) {
                    videoFrame.src = embedUrl;
                } else {
                    videoFrame.style.display = 'none';
                }
                clone.querySelector('.saveBtn').onclick = () => saveRecipe(recipe);
                clone.querySelector('.editBtn').onclick = () => editRecipe(recipe);
                results.appendChild(clone);
            });
        }
        function saveRecipe(recipe) {
            const tx = db.transaction('recipes','readwrite');
            tx.objectStore('recipes').put(recipe);
            tx.oncomplete = displaySavedRecipes;
        }
        function displaySavedRecipes() {
            const tx = db.transaction('recipes','readonly');
            const store = tx.objectStore('recipes');
            const saved = document.getElementById('savedRecipes');
            saved.innerHTML = '';
            store.openCursor().onsuccess = e => {
                const cursor = e.target.result;
                if(!cursor) return;
                const r = cursor.value;
                const div = document.createElement('div');
                div.className='recipe';
                const ingredients = [];
                for(let i=1;i<=20;i++){
                    const ing = r['strIngredient'+i], measure = r['strMeasure'+i];
                    if(ing && ing.trim()!=='') ingredients.push(`${measure || ''} ${ing}`.trim());
                }
                const instructionsSteps = parseInstructions(r.strInstructions);
                const embedUrl = getEmbedUrl(r.strYoutube);
                const videoHTML = embedUrl ? `<iframe class="recipe-video" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>` : '';
                div.innerHTML = `<h3>${r.strMeal}</h3>
                    <img src="${r.strMealThumb}" alt="Recipe Image">
                    ${videoHTML}
                    <h4>Ingredients:</h4>
                    <ul>${ingredients.map(i=>`<li>${i}</li>`).join('')}</ul>
                    <h4>Instructions:</h4>
                    <ol>${instructionsSteps.map(i=>`<li>${i}</li>`).join('')}</ol>
                    <button class="editBtn">Edit</button>`;

                div.querySelector('.editBtn').onclick = () => editRecipe(r);
                saved.appendChild(div);
                cursor.continue();
            };
        }
        function editRecipe(recipe) {
            const newInstructions = prompt('Edit instructions:', recipe.strInstructions);
            if(newInstructions !== null){
                recipe.strInstructions = newInstructions;
                saveRecipe(recipe);
            }
        }
        document.getElementById('searchBtn').onclick = () => fetchRecipes(document.getElementById('ingredientInput').value.trim());
        document.getElementById('randomBtn').onclick = () => fetchRecipes('random');
    </script>
</body>
</html>